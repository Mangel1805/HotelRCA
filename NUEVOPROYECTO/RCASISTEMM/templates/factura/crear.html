

{% extends "base.html" %}
{% block content %}
<div class="alert alert-info" role="alert"><h1>FACTURACION</h1></div>


<div class="well">
  <div class="row">
  <div class="col-md-6">
  <div class="alert alert-danger" role="alert">DATOS CLIENTES</div>
  		<div class="row">
        <div class="col-xs-6">
                                <label for="cedula">Cedula:</label>
                                <div class="input-group">
                                    <input class="form-control" type="search" name="cedula" id="txtcedula" required autocomplete="off" placeholder="Cedula"/ >
                                    <span class="input-group-btn"><button class="btn btn-info" type="button" value="Buscar" onclick="javascript:buscarCliente()"><i class="glyphicon glyphicon-search"></i></button></span>
                                </div>
                                <label for="nombre">Nombre:</label>
                                <input type="text" class="form-control" name="nombre" id="txtnombre" placeholder="Nombre" readonly="readonly">
                                <label for="apellido">Apellido:</label>
                                <input type="text" class="form-control" name="apellido" id="txtapellido" placeholder="Apellido" readonly="readonly">
                            </div>
                            <div class="col-xs-6">
                                <div class="row-fluid">
                                    <label for="direccion">Direccion:</label>
                                    <input type="text" class="form-control" name="direccion" id="txtdireccion" placeholder="Direccion" readonly="readonly">
                                    <label for="ciudad">Ciudad:</label>
                                    <input type="text" class="form-control" name="ciudad" id="txtciudad" placeholder="Ciudad" readonly="readonly">
                                    <label for="tlfono">Telefono:</label>
                                    <input type="text" class="form-control" name="tlfono" id="txttelefono" placeholder="Telefono" readonly="readonly">
                                </div>
                            </div>
      </div>
</div>
  <div class="col-md-6">
  		<div class="alert alert-danger" role="alert">DATOS FACTURA</div>
        <div class="col-md-6">NUMERO FACTURA</div>
        <div class="col-md-6"><input type="text" id="txtnfactura" class="form-control" required value="{{ nFactura }}" readonly="readonly"></div>
  		<div class="col-md-6">FECHA</div>
        <div class="col-md-6"><input type="text" id="txtfecha"  class="form-control" readonly="readonly" ></div>
  </div>
</div>
</div>

<div class="alert alert-danger" role="alert">PRODUCTOS</div>
<div class="well">
<div class="row">
    <div class="col-md-4">
    	<div class="form-group">
            <input class="form-control typeahead" type="text" id="txtbuscarproducto" placeholder="Buscar Producto" autocomplete="off" size="50" />
        	
        </div>

    </div>
    <div class="col-md-4">
    	<div class="input-group"><span class="input-group-addon">CANTIDAD</span>
    <input type="text" id="txtcantidad" class="form-control" placeholder="Agrege la Cantidad">
    </div>
    </div>
    <div class="col-md-4">
      <button type="button" onclick="addfilastabla()" class="btn btn-danger"><span class="glyphicon glyphicon-plus" > AÃ±adir</button>
    </div>
  </div>
<div>
    <br/>
   <div class="table-responsive">
   <table id="tablafactura"  class="table table-hover">
   <thead>
   	<tr>
    	<td class="success">CODIGO</td>
        <td class="success">DESCRIPCION</td>
        <td class="success">CANTIDAD</td>
        <td class="success">PRECIO U</td>
        <td class="success">PRECIO T</td>
        <td class="success">ELIMINAR</td>
        
    </tr>
   </thead>
   <tbody >
   </tbody>
   </table>
  
   </div>
   <div class="row">
      <div class="col-md-6">
      
      </div>
      <div class="col-md-6">
      
        		<div class="row">
        <div class="col-md-6">SUBTOTAL</div>
        <div class="col-md-6"><input type="text"  id="txtsubotal" value="0" class="form-control" placeholder="normal sized input group" readonly="readonly"></div>
        <div class="col-md-6">IVA</div>
        <div class="col-md-6"><input type="text"  id="txtiva" value="0" class="form-control" placeholder="normal sized input group"readonly="readonly"></div>
        <div class="col-md-6">DESCUENTO</div>
        <div class="col-md-6"><input type="text" id="txtdescuento" value="0" class="form-control" placeholder="normal sized input group" readonly="readonly"></div>
      	<div class="col-md-6">TOTAL</div>
        <div class="col-md-6"><input type="text" id="txttotal" value="0" class="form-control" placeholder="normal sized input group" readonly="readonly"></div>
      </div>

      </div>
    </div>
</div>
</div>


<div class="row">
        <div class="col-xs-5"></div>
          <div class="col-xs-2">
            <button type="button" class="btn btn-danger" id="btnGuardar"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> GUARDAR</button>
          <i class="icon-save"></i></button></div>
        <div class="col-xs-5"></div>

    </div>

{% endblock content %}
{% block js %} 
<script >
		 var f = new Date();
        document.getElementById('txtfecha').value=(f.getFullYear() + "-" + (f.getMonth() +1) + "-" + f.getDate());
        var fecha = (f.getFullYear() + "-" + (f.getMonth() +2) + "-" + f.getDate());
		var nombre = []



		var contador  = 0;
		{% for prod in listarproductos %}
			nombre[contador]="{{prod.nombre}}";
			console.log(nombre[contador]);
			contador=contador+1;
		{% endfor %}

        $('input.typeahead').typeahead({
                local: nombre
            });

		function buscarCliente(){
			var cedulaBuscar=document.getElementById("txtcedula").value;
			{% for cliente in listarclientes %}

          if("{{ cliente.cedula }}"==cedulaBuscar){
  				var nombre = "{{cliente.nombre}}"
  				var apellido = "{{cliente.apellido}}"
  				var direccion = "{{cliente.direccion}}"
  				var telefono = "{{cliente.telefono}}"
  				var ciudad = "{{cliente.ciudad}}"
  				document.getElementById("txtnombre").value=nombre;
  				document.getElementById("txtapellido").value=apellido;
  				document.getElementById("txtdireccion").value=direccion;
          document.getElementById("txttelefono").value=telefono;
          document.getElementById("txtciudad").value=ciudad;
				}
			{% endfor %}
		}

		function addfilastabla(){

			var productobuscar = document.getElementById("txtbuscarproducto").value;
      console.log(productobuscar)
			var productoCant = document.getElementById("txtcantidad").value;

			document.getElementById("txtbuscarproducto").value="";
			document.getElementById("txtcantidad").value="";

			var tabla = document.getElementById('tablafactura');
			var lastRow= tabla.rows.length;
			var row = tabla.insertRow(lastRow);
      var lp= 0
			{% for producto in listarproductos  %}
            console.log('aki')
				if("{{producto.nombre}}"==productobuscar){
						var codigo = row.insertCell(0);
						console.log(codigo);
            var producto=row.insertCell(1);
						var cantidad =row.insertCell(2);
						var preciou=row.insertCell(3);
						var preciot=row.insertCell(4);
						var eliminar=row.insertCell(5);

						codigo.innerHTML="{{producto.id}}";
						producto.innerHTML="{{producto.nombre}}";
						cantidad.innerHTML =productoCant;
						preciou.innerHTML= "{{producto.costo}}";
            console.log({{producto.costo}});
						pt = parseFloat("{{ producto.costo }}") * parseInt(productoCant);
            console.log(pt)
						preciot.innerHTML=pt;

						sumartotales();

						eliminar.innerHTML="<button class='btn btn-danger' onclick='eliminarfilas(this)'><span class='glyphicon glyphicon-remove' aria-hidden='true'></button>";
						return false;
					}
				 
			 {% endfor %}
		}

    function eliminarfilas(t){
      var td = t.parentNode;
      var tr = td.parentNode;
      var table = tr.parentNode;
      table.removeChild(tr)
      sumartotales()
    }

		function sumartotales(){

			var tabla = document.getElementById('tablafactura');
			var total=0;
			for(var i = 1;tabla.rows[i];i++){
				total+= Number(tabla.rows[i].cells[4].innerHTML);
			}
      console.log(total)
			llenarCamposTotales(total)

		}

		function llenarCamposTotales(subtotal){

      document.getElementById("txtsubotal").value=redondeo(subtotal);
      sub = parseFloat(document.getElementById("txtsubotal").value);
      document.getElementById("txtiva").value=redondeo(sub*0.12);
      iva = parseFloat(document.getElementById("txtiva").value)
      document.getElementById("txtdescuento").value=redondeo(parseFloat(sub)*0.05);

      descuento = parseFloat(document.getElementById("txtdescuento").value)

      total = document.getElementById("txttotal").value;
      document.getElementById("txttotal").value=redondeo(sub+iva+descuento);

			
			
		}

    function redondeo(numero){

      var flotante = parseFloat(numero);
      var resultado = Math.round(flotante*100)/100;
      return resultado;

    }
	
	$("#btnGuardar").click(
	function(){
		var tabla = document.getElementById('tablafactura');
		if (tabla.rows.length >1){
			
			for (var i = 1; tabla.rows[i];i++){
				$.get('factura/crear/',{
					codigo:document.getElementById("tablafactura").rows[i].cells[0].innerHTML,
					cantidad:document.getElementById("tablafactura").rows[i].cells[2].innerHTML,
					precio:document.getElementById("tablafactura").rows[i].cells[3].innerHTML,
					cedula:document.getElementById("txtcedula").value,
					nFactura:document.getElementById("txtnfactura").value,
					i:i,
					subtotal:document.getElementById("txtsubotal").value,
					iva:document.getElementById("txtiva").value,
					descuento:document.getElementById("txtdescuento").value,
					total:document.getElementById("txttotal").value,
					fecha:fecha
					});
				
				
				}

        alert("Datos Guardados Correctamente... ")

        setTimeout("location.href='/generarFacturaVenta'",2000);
			
			}
		
		
		}
	
	)

	</script>



  
{% endblock js %}
